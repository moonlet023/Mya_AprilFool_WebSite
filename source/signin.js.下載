(function(d,a){"use strict";var l=null,n,i={totalDays:null,totalWeeks:null,isFinishedAd:!1,debugFlag:!1,checkSigninStatus:async function(){let t=new Bahamut.Csrf;t.setCookie();let e=new FormData;return e.append("action",2),(await fetch("https://api.gamer.com.tw/user/v1/signin.php",{method:"POST",body:e,headers:t.getFetchHeaders(),credentials:"include"})).json()},signinWork:async function(){let t=new Bahamut.Csrf;t.setCookie();let e=new FormData;return e.append("action",1),(await fetch("https://api.gamer.com.tw/user/v1/signin.php",{method:"POST",body:e,headers:t.getFetchHeaders(),credentials:"include"})).json()},signinSuccessAnime:function(){setTimeout(function(){l.$content.find(".before-active").addClass("is-active")},850)},load:function(){this.checkSigninStatus().then(t=>{let e=d("#signin-btn");if(t.error)return e.html(t.error.message),!1;parseInt(t.data.signin,10)==1&&(e.addClass("is-active"),e.attr("onclick","Signin.showSigninMap();")),this.totalDays=t.data.days,this.totalWeeks=t.data.totalWeeks,this.isFinishedAd=t.data.finishedAd,e.html(t.data.btnMessage)})},start:function(){if(!a.User.Login.requireLoginIframe())return!1;this.signinWork().then(t=>{if(t.error)return Dialogify.alert(t.error.message),!1;this.totalDays=t.data.days,this.totalWeeks=t.data.totalWeeks,this.isFinishedAd=!1,this.openSigninMap("signin"),this.signinSuccessAnime();let e=d("#signin-btn");e.addClass("is-active"),e.html(t.data.btnMessage),e.attr("onclick","Signin.showSigninMap();"),(t.data.dialogInfo.title||t.data.dialogInfo.image||t.data.dialogInfo.content)&&this.showBonusCard(t.data.dialogInfo)})},showSigninMap:function(){this.totalDays!=null&&this.totalWeeks!=null?this.openSigninMap("check"):this.checkSigninStatus().then(t=>{if(t.error)return Dialogify.alert(t.error.message),!1;this.totalDays=t.data.days,this.totalWeeks=t.data.totalWeeks,this.isFinishedAd=t.data.finishedAd,this.openSigninMap("check")})},openSigninMap:function(t){nunjucks.configure({autoescape:!1});let e=nunjucks.render("signin_dialog.njk.html",{totalDays:this.totalDays,totalWeeks:this.totalWeeks,action:t,isFinishedAd:this.isFinishedAd});l=new Dialogify(e,{useDialogForm:!1,size:"popup-dailybox--width",dialog:{className:"popup-dailybox"}}),l.showModal()},showBonusCard:function(t){nunjucks.configure({autoescape:!1});let e=nunjucks.render("signin_bonus.njk.html",{image:t.image,title:t.title,content:t.content}),o=new Dialogify(e,{useDialogForm:!1,size:"popup-dailybox-tip--width",dialog:{className:"popup-dailybox-tip"}});setTimeout(function(){o.showModal()},850),setTimeout(function(){o.$content.find(".popup-dailybox-tip__stamp").show()},1e3),setTimeout(function(){o.close()},8e3)},mobile:function(){if(!a.User.Login.isLogin())return!1;this.checkSigninStatus().then(t=>{if(t.error)return!1;this.isFinishedAd=t.data.finishedAd,t.data.signin==0?i.signinWork().then(e=>{if(e.error)return!1;i.totalDays=e.data.days,i.totalWeeks=e.data.totalWeeks,i.openSigninMap("signin"),i.signinSuccessAnime(),(e.data.dialogInfo.title||e.data.dialogInfo.image||e.data.dialogInfo.content)&&i.showBonusCard(e.data.dialogInfo),i.load()}):(i.totalDays=t.data.days,i.totalWeeks=t.data.totalWeeks,i.openSigninMap("check"))})},auto:function(t=!1){if(!a.User.Login.isLogin())return!1;let e=new Date,o=!0,g=location.hostname;e.getHours()===0&&e.getMinutes()>=0&&e.getMinutes()<=5&&g=="buy.gamer.com.tw"&&(o=!1),this.checkSigninStatus().then(s=>{if(s.error)return!1;if(a.location.hostname=="ani.gamer.com.tw"){if(s.data.open_auto_ani!=1)return!1}else if(s.data.close_auto==1)return!1;this.isFinishedAd=s.data.finishedAd,s.data.signin==0?i.signinWork().then(r=>{if(r.error)return!1;i.totalDays=r.data.days,i.totalWeeks=r.data.totalWeeks,o==!0?(i.openSigninMap("signin"),i.signinSuccessAnime(),(r.data.dialogInfo.title||r.data.dialogInfo.image||r.data.dialogInfo.content)&&i.showBonusCard(r.data.dialogInfo),n.contentWindow.postMessage({action:"show_dialog_done",userid:a.User.Login.getUserid()},"https://api.gamer.com.tw")):n.contentWindow.postMessage({action:"need_show_dialog",userid:a.User.Login.getUserid()},"https://api.gamer.com.tw"),n.contentWindow.postMessage({action:"finish",userid:a.User.Login.getUserid()},"https://api.gamer.com.tw"),i.load()}):(i.totalDays=s.data.days,i.totalWeeks=s.data.totalWeeks,i.debugFlag==!0?i.openSigninMap("check"):t==!0&&o==!0&&(i.openSigninMap("signin"),i.signinSuccessAnime(),(s.data.dialogInfo.title||s.data.dialogInfo.image||s.data.dialogInfo.content)&&i.showBonusCard(s.data.dialogInfo),n.contentWindow.postMessage({action:"show_dialog_done",userid:a.User.Login.getUserid()},"https://api.gamer.com.tw")),n.contentWindow.postMessage({action:"finish",userid:a.User.Login.getUserid()},"https://api.gamer.com.tw"))})},debug:function(){n.contentWindow.postMessage({action:"debug"},"https://api.gamer.com.tw")},setDebug:function(){this.debugFlag=!0}};a.Signin=i,a.onmessage=function(t){t.origin=="https://api.gamer.com.tw"&&t.data=="auto_signin"&&a.Signin.auto(),t.origin=="https://api.gamer.com.tw"&&t.data=="show_dialog"&&a.Signin.auto(!0),t.origin=="https://api.gamer.com.tw"&&t.data=="debug"&&a.Signin.setDebug()},d(function(){typeof a.User<"u"&&typeof a.User.Login<"u"&&a.User.Login.isLogin()&&(n=document.createElement("iframe"),n.src="https://api.gamer.com.tw/worker/signin.html",n.onload=function(){this.contentWindow.postMessage({action:"check",userid:a.User.Login.getUserid()},"https://api.gamer.com.tw")},n.style.display="none",document.body.appendChild(n))})})(jQuery,window);
